<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Patient Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<h2>Patient Dashboard</h2>

<button onclick="logout()">Logout</button>

<div>
    <h3>My Appointments</h3>
    <ul id="appointments"></ul>
</div>

<div>
    <h3>Lab Results</h3>
    <ul id="labResults"></ul>
</div>

<div>
    <h3>Chatbot</h3>
    <div id="chatbox"></div>
    <input type="text" id="userInput" placeholder="Ask AI..." />
    <button type="button" onclick="sendMessage()">Send</button>
</div>

<script th:src="@{/js/chat.js}" src="/static/js/chat.js"></script>
<script th:inline="javascript">
    const token = localStorage.getItem('token');

    if (!token) {
        // Redirect to login if no token
        window.location.href = CONTEXT_PATH + 'login';
    }

    // Reuse fetchWithAuth from auth.js
    async function fetchWithAuth(url, options = {}) {
        options.headers = {
            ...(options.headers || {}),
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
        };
        const response = await fetch(url, options);
        if (response.status === 403) {
            console.warn('Access denied (403) for', url);
        }
        return response;
    }

    // Load patient appointments
    async function loadAppointments() {
        try {
            const response = await fetchWithAuth(`${CONTEXT_PATH}api/patient/appointments`);
            if (!response.ok) throw new Error('Failed to fetch appointments');
            const data = await response.json();
            const list = document.getElementById('appointments');
            list.innerHTML = '';
            data.forEach(a => {
                const li = document.createElement('li');
                li.textContent = `${a.datetime} with Dr. ${a.doctor.name} (Status: ${a.status})`;
                list.appendChild(li);
            });
        } catch (err) {
            console.error(err);
        }
    }

    // Load lab results
    async function loadLabResults() {
        try {
            const response = await fetchWithAuth(`${CONTEXT_PATH}api/patient/lab-results`);
            if (!response.ok) throw new Error('Failed to fetch lab results');
            const data = await response.json();
            const list = document.getElementById('labResults');
            list.innerHTML = '';
            data.forEach(l => {
                const li = document.createElement('li');
                li.textContent = `${l.test.name}: ${l.value} (Status: ${l.status})`;
                list.appendChild(li);
            });
        } catch (err) {
            console.error(err);
        }
    }

    // Initial load
    loadAppointments();
    loadLabResults();

</script>
</body>
</html>
